<!doctype html>
<html class="theme-next use-motion theme-next-mist">
<head>
  

<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>






  <link rel="stylesheet" type="text/css" href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5"/>



  <link href='http://fonts.googleapis.com/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext' rel='stylesheet' type='text/css'>


<link rel="stylesheet" type="text/css" href="/css/main.css?v=0.4.3"/>




  <meta name="keywords" content="Hexo,next" />





  <link rel="shorticon icon" type="image/x-icon" href="/favicon.ico?v=0.4.3" />



<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: 'Mist',
    analytics: {
      google: ''
    },
    sidebar: 'hide'
  };
</script>




  <title> Be smart and make thins done </title>
</head>

<body>
  <!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->

  <div class="container one-column 
   page-home 
">
    <div class="headband"></div>

    <div id="header" class="header">
      <div class="header-inner">
        <h1 class="site-meta">
  <span class="logo-line-before"><i></i></span>
  <a href="/" class="brand">
      <span class="logo">
        <i class="icon-logo"></i>
      </span>
      <span class="site-title">Be smart and make thins done</span>
  </a>
  <span class="logo-line-after"><i></i></span>
</h1>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<div class="site-nav">
  

  
    <ul id="menu" class="menu ">
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories">
            <i class="menu-item-icon icon-categories"></i> <br />
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about">
            <i class="menu-item-icon icon-about"></i> <br />
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            <i class="menu-item-icon icon-archives"></i> <br />
            Archives
          </a>
        </li>
      
    </ul>
  

  
</div>


      </div>
    </div>

    <div id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content">
          
  <div id="posts" class="posts-expand">
    
      

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="/2015/07/30/ios-notes-media-player/">
                ios notes media play
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          Posted on 2015-07-30
        </span>

        
          <span class="post-category">
            &nbsp; | &nbsp; In
            
              <a href="/categories/iOS/">iOS</a>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2015/07/30/ios-notes-media-player/#comments" >
              <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/07/30/ios-notes-media-player/"></span>
            </a>
          </span>
          
        
      </div>
    </div>

    <div class="post-body">

      
      

      
        
          <h2 id="iOS学习笔记之——媒体播放">iOS学习笔记之——媒体播放</h2><p>在iOS中提供了两种播放媒体的两个类:<code>MPMoviePlayerController</code>和<code>MPMoviePlayerViewController</code>，让我们可以轻松地播放媒体文件。其中<code>MPMoviePlayerViewController</code> 只能全屏播放，下面我们就来动手试一试吧。</p>
<h5 id="（一）导入依赖项">（一）导入依赖项</h5><p>在写代码之前我们需要引入一个依赖项到XCode：<code>MediaPlayer.Framework</code>。<br>图片。。。。<br><code>MPMoviePlayerController</code>内部有个view用来展示视频内容，添加其他<code>Controller</code>的View上面就可实现播放。目前支持的视频格式有<code>H.264</code>和<code>MPEG-4 Part 2 video</code>两种。支持的文件扩展名为：avi、mkv、mov、m4v、mp4等。可以到苹果官网下载一些用来测试的小<a href="http
://support.apple.com/kb/ht1424">视频文件</a>。沙盒里面取视频文件</p>
<h5 id="（二）动手写代码">（二）动手写代码</h5><p>新建一个<code>Controller</code>将头文件导入。</p>
<pre><code><span class="id">#import</span> <span class="string">"MainViewController.h"</span>
<span class="id">#import</span> &lt;MediaPlayer/MediaPlayer.h&gt;
</code></pre><p>声明一个属性</p>
<pre><code><span class="variable">@interface</span> MainViewController ()
<span class="variable">@property</span> (strong, nonatomic) MPMoviePlayerController *player;<span class="comment">//注意：如果定义在viewDidLoad中的话将会无法播放、因为出了`viewDidLoad`之后*player会被销毁掉了。</span>
<span class="variable">@property</span> (strong, nonatomic) UIImageView *imageView;
<span class="variable">@end</span>
</code></pre><p>接下来在<code>viewDidLoad</code>里面初始化视频播放器并添加到<code>RootViewController</code></p>
<pre><code><span class="built_in">NSURL</span> *url = [[<span class="built_in">NSBundle</span> mainBundle]URLForResource:<span class="string">@"promo_full"</span> withExtension:<span class="string">@"mp4"</span>];
 <span class="keyword">self</span><span class="variable">.player</span> = [[<span class="built_in">MPMoviePlayerController</span> alloc]initWithContentURL:url];
 [<span class="keyword">self</span><span class="variable">.player</span><span class="variable">.view</span> setFrame:<span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">320</span>, <span class="number">180</span>)];   <span class="comment">//16:9比例</span>
 [<span class="keyword">self</span><span class="variable">.view</span> addSubview:<span class="keyword">self</span><span class="variable">.player</span><span class="variable">.view</span>];
 [<span class="keyword">self</span><span class="variable">.player</span> play];
</code></pre><p>到目前为止我们就可以实现播放视频了。是不是很简单？<br>图片。。。</p>
<h5 id="（三）思考">（三）思考</h5><p>通常我们使用主流的播放器一般都会有记录上次播放位置、视频页面截图、视频结束弹出广告，如何实现呢。这就需要通过通知中心，以观察者模式监视视频模仿的状态了,下面是一个播放时全屏的例子。</p>
<pre><code>[[NSNotificationCenter <span class="keyword">default</span>Center]addObserver:<span class="literal">self</span> selector:@selector(<span class="keyword">state</span>Listener) name:MPMoviePlayerPlaybackStateDidChangeNotification object:nil];
</code></pre><p>接着我们需要写一个监听方法在视频播放的时候<code>MPMoviePlaybackStatePlaying</code>来设置<code>Fullscreen</code>就可以了</p>
<pre><code>- (<span class="keyword">void</span>)stateListener
{
    <span class="keyword">if</span> (<span class="keyword">self</span><span class="variable">.player</span><span class="variable">.playbackState</span>==<span class="built_in">MPMoviePlaybackStatePlaying</span>) {
            [<span class="keyword">self</span><span class="variable">.player</span> setFullscreen:<span class="literal">YES</span> animated:<span class="literal">YES</span>];    <span class="comment">// 设置全屏播放</span>
            <span class="built_in">NSLog</span>(<span class="string">@"播放"</span>);
    }
}
<span class="keyword">@end</span>
</code></pre><p>接下来我们再来实现一个视频截图的功能，首先我们需要准备一个<code>UIImageView</code>加到<code>RootViewController</code>里面来显示我们的截图。</p>
<pre><code> [[<span class="built_in">NSNotificationCenter</span> defaultCenter]addObserver:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(caputerImage:) name:<span class="built_in">MPMoviePlayerThumbnailImageRequestDidFinishNotification</span> object:<span class="literal">nil</span>]; 

[<span class="keyword">self</span><span class="variable">.player</span> requestThumbnailImagesAtTimes:@[@<span class="number">10.0</span>f, @<span class="number">20.0</span>f] timeOption:<span class="built_in">MPMovieTimeOptionNearestKeyFrame</span>]; <span class="comment">//指定一个截图时间区间</span>
<span class="built_in">UIImageView</span> *thumbnailImageView = [[<span class="built_in">UIImageView</span> alloc]initWithFrame:<span class="built_in">CGRectMake</span>(<span class="number">80</span>, <span class="number">200</span>, <span class="number">160</span>, <span class="number">90</span>)];
<span class="keyword">self</span><span class="variable">.imageView</span> = thumbnailImageView;
[<span class="keyword">self</span><span class="variable">.view</span> addSubview:thumbnailImageView];
</code></pre><p>接下来同样需要一个监听方法来完成截图功能。</p>
<pre><code>- (<span class="keyword">void</span>)caputerImage:(<span class="built_in">NSNotification</span> *)notification
{
    <span class="built_in">NSLog</span>(<span class="string">@"截图 %@"</span>, notification);
    <span class="built_in">UIImage</span> *image = notification<span class="variable">.userInfo</span>[<span class="string">@"MPMoviePlayerThumbnailImageKey"</span>];
    [<span class="keyword">self</span><span class="variable">.imageView</span> setImage:image];
}
</code></pre><h4 id="总结">总结</h4><p>基于苹果给我们封装了很多细节，我们可以很轻松的实现很多常用的功能。还有<code>MPMoviePlayerViewController</code>大体功能差不多就不一一介绍了。</p>

        
      
    </div>

    <div class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </div>
  </div>


    
      

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="/2015/07/30/Swift-what-is-the-AnyObject/">
                Swift: 什么是 AnyObject
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          Posted on 2015-07-30
        </span>

        
          <span class="post-category">
            &nbsp; | &nbsp; In
            
              <a href="/categories/iOS/">iOS</a>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2015/07/30/Swift-what-is-the-AnyObject/#comments" >
              <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/07/30/Swift-what-is-the-AnyObject/"></span>
            </a>
          </span>
          
        
      </div>
    </div>

    <div class="post-body">

      
      

      
        
          <h2 id="什么是AnyObjct">什么是AnyObjct</h2><p>为了方便理解你可以将 <code>AnyObject</code> 类比成一种类型，就像 <code>Array</code> 或 <code>Double</code> 一样，但事实上它并不是一种类型。它主要用于兼容现有的 Objective-c API 和 iOS 代码， <code>AnyObject</code> 可以用来构建自己的数据结构，但并不经常使用。这有点不像 Swift，因为 Swift 是强类型语言，并且有类型推断的特性。 <code>AnyObject</code> 是只想一个对象（未知类）的指针，这有点奇怪哈。</p>
<h2 id="什么时候用到_AnyObject">什么时候用到 AnyObject</h2><p>有可能在变量中见到：</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="variable"><span class="keyword">var</span> destinationViewController</span>: AnyObject</span><br><span class="line"><span class="variable"><span class="keyword">var</span> toolbarItems</span>: [AnyObject]</span><br></pre></td></tr></table></figure>
<p>或者在方法参数中出现：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="func"><span class="keyword">func</span> <span class="title">prepareForSegue</span><span class="params">(segue: UIStoryboardSegue, sender: AnyObject)</span></span></span><br><span class="line"><span class="func"><span class="keyword">func</span> <span class="title">addConstraints</span><span class="params">(constrains: [AnyObject])</span></span></span><br><span class="line"><span class="func"><span class="keyword">func</span> <span class="title">appendString</span><span class="params">(sender: AnyObject)</span></span></span><br></pre></td></tr></table></figure>
<p>甚至可以作为一个方法的返回值：</p>
<figure class="highlight delphi"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="function"><span class="keyword">function</span> <span class="title">buttonWithType</span><span class="params">(buttonType: UIButtonType)</span> -&gt; <span class="title">AnyObject</span></span></span><br></pre></td></tr></table></figure>
<p>在我们使用 Storyboard 进行连线时候出现：</p>
<h2 id="如何使用_AnyObject">如何使用 AnyObject</h2><p>既然它是指针，我们就不可能发送任何消息给它。<code>为了使用它，我们要把它转换成一种我们已知的类型，这也是我们唯一使用它的方式</code> 例如：</p>
<figure class="highlight cs"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> destinationViewController: AnyObject</span><br><span class="line"><span class="keyword">let</span> planVC = destinationViewController <span class="keyword">as</span> planInfoViewController</span><br></pre></td></tr></table></figure>
<p>如果 dvc 为空，会 Crash</p>
<p>安全转换有两种办法避免：</p>
<figure class="highlight nimrod"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="keyword">let</span> planVC = destinationViewController <span class="keyword">as</span>? planInfoViewController <span class="decorator">&#123;...&#125;</span> // <span class="keyword">as</span>? 会返回一个 <span class="type">Optional</span> 版本</span><br></pre></td></tr></table></figure>
<p>or</p>
<figure class="highlight nimrod"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> destinationViewController <span class="keyword">is</span> planInfoViewController <span class="decorator">&#123;...&#125;</span> //如果 <span class="literal">true</span> 那么就可以进行 <span class="keyword">as</span> 操作了</span><br></pre></td></tr></table></figure>
<p>我更喜欢第一种，检查与转换一次搞定。</p>

        
      
    </div>

    <div class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </div>
  </div>


    
      

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="/2015/07/17/ios-notes-synthesize/">
                iOS 学习笔记 — @synthesize合成指令
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          Posted on 2015-07-17
        </span>

        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2015/07/17/ios-notes-synthesize/#comments" >
              <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/07/17/ios-notes-synthesize/"></span>
            </a>
          </span>
          
        
      </div>
    </div>

    <div class="post-body">

      
      

      
        
          <p>许多编程语言中，在程序员编写一个<code>@property</code>时候，编译器为了减轻程序员的工作量都会自动给<code>@property</code>自动生成两个以下划线开头的成员变量，就跟下面一样。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="at_rule">@<span class="keyword">property</span> NSString *firstName</span>;</span><br></pre></td></tr></table></figure>
<p>因此 Xcode 4.4的以前的版本给程序员提供了 <code>@sythesize</code> 关键字来生成下划线开头的成员变量，每当声明一个属性之后都必须用 <code>@sythesize</code> 在 <code>implementation</code> 里面告诉编译器，编译器才会给生成下划线开头的成员变量方法。下面代码做个演示。</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>,<span class="keyword">strong</span>) <span class="built_in">NSString</span> *someProperty;<span class="comment">//声明一个变量</span></span><br><span class="line"></span><br><span class="line">@sythesize someProperty = _someProperty； <span class="comment">// 必须使用 合成指令告诉编译器，其才会生成该属性需要的成员变量。</span></span><br></pre></td></tr></table></figure>
<p> 因为这样，Xcode 4.4以前版本的程序员做开发比较郁闷的时候，就是需要声明很多属性的时候就会出现一堆 <code>@sythesize</code> 。之后，苹果发现这个问题之后呢，在 Xcode 4.5以后的版本对其进行改进，不再需要程序员手动去调用 <code>@sythesize</code> 指令也可以自动生成带下划线的成员变量了。</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">parentViewController</span>（）</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>,<span class="keyword">strong</span>) <span class="built_in">NSString</span> *someProperty; <span class="comment">//父类的属性</span></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">childViewController</span></span></span><br><span class="line">@sythesize someProperty = _someProperty；</span><br><span class="line">@(<span class="keyword">void</span>)someMethod</span><br><span class="line">&#123;</span><br><span class="line">	 <span class="keyword">self</span><span class="variable">.someProperty</span> <span class="comment">//循环引用..</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>这么一来简化了程序员的工作量，但是当成员变量出现在父类的情况下，子类如果需要调用父类的成员变量时，编译器不会给子类也生成相应的下划线成员变量。Xcode 则推荐我们使用<code>self</code>关键字。但是通过 <code>self.someProperty</code> 调用父类的成员变量时候，是调用属性的 <code>getter</code> 方法，<code>getter</code>  调用时候再 <code>getter</code> 自己的时候就会形成循环引用的问题。</p>
<p>明白了这个之后，往后在子类调用父类的变量时候，手动调用一下 <code>@sythesize</code> 就可以了。</p>
<p>参考：</p>
<p><a href="https://developer.apple.com/library/mac/documentation/Cocoa/Conceptual/ProgrammingWithObjectiveC/EncapsulatingData/EncapsulatingData.html#//apple_ref/doc/uid/TP40011210-CH5-SW1" target="_blank" rel="external">Programming with Objective-C</a></p>
<p><a href="http://stackoverflow.com/questions/3266467/what-exactly-does-synthesize-do" target="_blank" rel="external">What exactly does @synthesize do?</a></p>
<p><a href="http://stackoverflow.com/questions/15606151/objective-c-is-synthesize-required-or-optional" target="_blank" rel="external">Objective-C is @synthesize required or optional?</a></p>
<p><a href="http://stackoverflow.com/questions/9368676/under-what-conditions-is-synthesize-automatic-in-objective-c/11767553#11767553" target="_blank" rel="external">Under what conditions is @synthesize automatic in Objective-c?</a></p>

        
      
    </div>

    <div class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </div>
  </div>


    
      

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="/2015/07/09/My-New-Post/">
                My New Post
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          Posted on 2015-07-09
        </span>

        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2015/07/09/My-New-Post/#comments" >
              <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/07/09/My-New-Post/"></span>
            </a>
          </span>
          
        
      </div>
    </div>

    <div class="post-body">

      
      

      
        
          
        
      
    </div>

    <div class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </div>
  </div>


    
      

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="/2013/12/02/hexo mac osx tutorial/">
                postName
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          Posted on 2013-12-02
        </span>

        
          <span class="post-category">
            &nbsp; | &nbsp; In
            
              <a href="/categories/iOS/">iOS</a>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2013/12/02/hexo mac osx tutorial/#comments" >
              <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2013/12/02/hexo mac osx tutorial/"></span>
            </a>
          </span>
          
        
      </div>
    </div>

    <div class="post-body">

      
      

      
        
          <h1 id="安装过程">安装过程</h1><ul>
<li><p>github 账号</p>
</li>
<li><p>Homebrew 安装</p>
</li>
<li><p>brew install node</p>
</li>
<li><p>npm install hexo -g</p>
</li>
<li><p>hexo init [folder]</p>
</li>
<li><p>npm install hexo-server —save</p>
</li>
<li><p>npm install</p>
</li>
<li><p>npm install hexo-deployer-git —save</p>
</li>
<li><p>hexo deploy</p>
<p>​</p>
<p>​</p>
</li>
</ul>

        
      
    </div>

    <div class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </div>
  </div>


    
      

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="/2013/12/02/hello-world/">
                postName
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          Posted on 2013-12-02
        </span>

        
          <span class="post-category">
            &nbsp; | &nbsp; In
            
              <a href="/categories/iOS/">iOS</a>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2013/12/02/hello-world/#comments" >
              <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2013/12/02/hello-world/"></span>
            </a>
          </span>
          
        
      </div>
    </div>

    <div class="post-body">

      
      

      
        
          <p>Welcome to <a href="http://hexo.io/" target="_blank" rel="external">Hexo</a>! This is your very first post. Check <a href="http://hexo.io/docs/" target="_blank" rel="external">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="http://hexo.io/docs/troubleshooting.html" target="_blank" rel="external">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="external">GitHub</a>.</p>
<h2 id="Quick_Start">Quick Start</h2><h3 id="Create_a_new_post">Create a new post</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>
<p>More info: <a href="http://hexo.io/docs/writing.html" target="_blank" rel="external">Writing</a></p>
<h3 id="Run_server">Run server</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>More info: <a href="http://hexo.io/docs/server.html" target="_blank" rel="external">Server</a></p>
<h3 id="Generate_static_files">Generate static files</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<p>More info: <a href="http://hexo.io/docs/generating.html" target="_blank" rel="external">Generating</a></p>
<h3 id="Deploy_to_remote_sites">Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<p>More info: <a href="http://hexo.io/docs/deployment.html" target="_blank" rel="external">Deployment</a></p>

        
      
    </div>

    <div class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </div>
  </div>


    
      

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="/2013/10/17/block-theory-in-iOS/">
                iOS 中 Block 原理
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          Posted on 2013-10-17
        </span>

        
          <span class="post-category">
            &nbsp; | &nbsp; In
            
              <a href="/categories/iOS/">iOS</a>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2013/10/17/block-theory-in-iOS/#comments" >
              <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2013/10/17/block-theory-in-iOS/"></span>
            </a>
          </span>
          
        
      </div>
    </div>

    <div class="post-body">

      
      

      
        
          <p>在OC中提供一个块代码，类似 javaScript 中的闭包(值捕获)。先来看一个例子</p>
<pre><code><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[])</span>
</span>{
    <span class="annotation">@autoreleasepool</span> {

        <span class="comment">//__block int temp = 10;</span>
        <span class="keyword">int</span> temp = <span class="number">10</span>;
        <span class="keyword">void</span> (^block)() = ^{ <span class="comment">// 值捕获</span>
            NSLog(@<span class="string">"temp=%d"</span>, temp);
        };

        temp = <span class="number">20</span>;
        block();
    }
    <span class="keyword">return</span> <span class="number">0</span>;
}
</code></pre><p>答案是：temp = 10。那么如果在 temp 前面加了 __blcok 修饰符 temp = 20，这是为什么呢？</p>
<p>接下来我们使用 clang -rewrite-objc 指令将 OC 代码转换成 C++ 代码，执行完毕之后。我们会得到一个 9万多行的 .cpp 文件，也就是说我们上面写的 几行代码，居然编译出 9万多行的代码。打开文件 直接拖到最下面，找到我们的 main 函数。</p>
<pre><code>int main<span class="params">(int argc, const char * argv[])</span>
{
    <span class="comment">/* @autoreleasepool */</span> { __AtAutoreleasePool __autoreleasepool; 
        int temp = <span class="number">10</span>;
        void <span class="params">(*block)</span><span class="params">()</span> = <span class="params">(void <span class="params">(*)</span><span class="params">()</span>)</span>&amp;__main_block_impl_0<span class="params">(<span class="params">(void     *)</span>__main_block_func_0, &amp;__main_block_desc_0_DATA, temp)</span>;
        temp = <span class="number">20</span>;
        <span class="params">(<span class="params">(void <span class="params">(*)</span><span class="params">(__block_impl *)</span>)</span><span class="params">(<span class="params">(__block_impl *)</span>block)</span>-&gt;FuncPtr)</span>    <span class="params">(<span class="params">(__block_impl *)</span>block)</span>;
    }
    return <span class="number">0</span>;
}
</code></pre><p>由编译后的C++代码可以看出，没有加 __block 修饰符的 temp 是直接将 自己本身的值传递到 Block 中（值捕获）了。 这个时候你在怎么修改 temp 的值，都已经跟 Block 无关了。所以 temp 的值不会改变。</p>
<p>接下来我们再看一下 加了 __block 修饰符的 temp 生成的代码是怎样的。</p>
<pre><code>int main<span class="params">(int argc, const char * argv[])</span>
{
    <span class="comment">/* @autoreleasepool */</span> { __AtAutoreleasePool __autoreleasepool; 
        __attribute__<span class="params">(<span class="params">(__blocks__<span class="params">(byref)</span>)</span>)</span> __Block_byref_temp_0 temp = {<span class="params">(void*)</span><span class="number">0</span>,<span class="params">(__Block_byref_temp_0 *)</span>&amp;temp, <span class="number">0</span>, sizeof<span class="params">(__Block_byref_temp_0)</span>, <span class="number">10</span>};
        void <span class="params">(*block)</span><span class="params">()</span> = <span class="params">(void <span class="params">(*)</span><span class="params">()</span>)</span>&amp;__main_block_impl_0<span class="params">(<span class="params">(void *)</span>__main_block_func_0, &amp;__main_block_desc_0_DATA, <span class="params">(__Block_byref_temp_0 *)</span>&amp;temp, <span class="number">570425344</span>)</span>;
        <span class="params">(temp.__forwarding-&gt;temp)</span> = <span class="number">20</span>;
        <span class="params">(<span class="params">(void <span class="params">(*)</span><span class="params">(__block_impl *)</span>)</span><span class="params">(<span class="params">(__block_impl *)</span>block)</span>-&gt;FuncPtr)</span><span class="params">(<span class="params">(__block_impl *)</span>block)</span>;
    }
    return <span class="number">0</span>;
}
</code></pre><p>这个时候我们看到，temp 已经不叫 temp 了。编译器生成了一堆以 下划线开头的 属性，但是我们还是可以找到，它是将 &amp;temp 的指针传进去了。</p>
<p>然后我们把 <code>(void (*)())</code> 强转的代码给删掉，方便阅读。接下来我们再看看 Block 本质是上面。</p>
<pre><code>void <span class="list">(<span class="keyword">*block</span>)</span><span class="list">()</span> = &amp;__main_block_impl_0<span class="list">(<span class="keyword">__main_block_func_0</span>, <span class="keyword">&amp;__main_block_desc_0_DATA</span>, temp)</span><span class="comment">;</span>
</code></pre><p>现在可以看出， Block 实际上就是一个指向 __main_block_impl_0 结构体的指针。</p>
<pre><code><span class="keyword">struct</span> __main_block_impl_0 {
  <span class="keyword">struct</span> __block_impl <span class="keyword">impl</span>;
  <span class="keyword">struct</span> __main_block_desc_0* Desc;
  <span class="keyword">int</span> temp;
  __main_block_impl_0(void *fp, <span class="keyword">struct</span> __main_block_desc_0 *desc, <span class="keyword">int</span> _temp, <span class="keyword">int</span> flags=<span class="number">0</span>) : temp(_temp) {
    <span class="keyword">impl</span>.isa = &amp;_NSConcreteStackBlock; 
    <span class="keyword">impl</span>.Flags = flags;
    <span class="keyword">impl</span>.FuncPtr = fp;
    Desc = desc;
  }
};
</code></pre><p>因为 C++ 结构体是有构造函数的，第四个参数为默认值，<code>temp(_temp)</code> 是将_temp的值赋值给 temp 。所以在函数中没有看到 对 temp 赋值的操作。搞定这个之后，我们再来看看 __main_block_func_0 函数里面到底是什么东西。</p>
<pre><code><span class="keyword">static</span> <span class="keyword">void</span> __main_block_func_0(<span class="keyword">struct</span> __main_block_impl_0 *__cself) {
  <span class="keyword">int</span> temp = __cself-&gt;temp; <span class="comment">// bound by copy</span>

            <span class="built_in">NSLog</span>((<span class="built_in">NSString</span> *)&amp;__<span class="built_in">NSConstantStringImpl__var_folders__g_yvmzw12106sgs14rz4yj_msw0000gn_T_main_c4b143_mi_0</span>, temp);
        }
</code></pre><p>看到我们熟悉的 NSLog , 到这里我们可以看出，Block 实际就是把我们写的所有 Block 代码生成一个函数，然后将函数指针传给了 __main_block_func_0 结构体，并同时把 temp 的值传到Block 里面，所以当 Block 在调用时候，实际上就是在调用函数。</p>
<h3 id="block_内存管理_Tips">block 内存管理 Tips</h3><pre><code>// <span class="number">1</span>.如果没有对<span class="keyword">block</span>进行copy操作，<span class="keyword">block</span>就存储于栈空间
// <span class="number">2</span>.如果对<span class="keyword">block</span>进行copy操作，<span class="keyword">block</span>就存储于堆空间
// <span class="number">3</span>.如果<span class="keyword">block</span>存储于栈空间，不会对<span class="keyword">block</span>内部所用到的对象产生强引用
// <span class="number">4</span>.如果<span class="keyword">block</span>存储于堆空间，就会对<span class="keyword">block</span>内部所用到的对象产生强引用
</code></pre>
        
      
    </div>

    <div class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </div>
  </div>


    
  </div>

  

        </div>

        
      </div>


      
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <div id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      <div class="site-overview">
        <div class="site-author motion-element">
          <img class="site-author-image" src="https://avatars0.githubusercontent.com/u/4646907?v=3&s=460" alt="typore" />
          <p class="site-author-name">typore</p>
        </div>
        <p class="site-description motion-element"></p>
        <div class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">7</span>
              <span class="site-state-item-name">posts</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            <a href="/categories">
              <span class="site-state-item-count">1</span>
              <span class="site-state-item-name">categories</span>
              </a>
          </div>

          <div class="site-state-item site-state-tags">
            
              <span class="site-state-item-count">2</span>
              <span class="site-state-item-name">tags</span>
              
          </div>

        </div>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
              <a href="https://github.com/smartv" target="_blank">github</a>
            </span>
            
              <span class="links-of-author-item">
              <a href="https://twitter.com/easySmartv" target="_blank">twitter</a>
            </span>
            
              <span class="links-of-author-item">
              <a href="http://weibo.com/712387780" target="_blank">weibo</a>
            </span>
            
              <span class="links-of-author-item">
              <a href="http://www.zhihu.com/people/smartv" target="_blank">zhihu</a>
            </span>
            
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
        </div>
        
      </div>

      

    </div>
  </div>


    </div>

    <div id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy; &nbsp; 
  2015
  <span class="with-love">
    <i class="icon-heart"></i>
  </span>
  <span class="author">typore</span>
</div>

<div class="powered-by">
  Powered by <a class="theme-link" href="http://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>



      </div>
    </div>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.3"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.3"></script>
  

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/js/motion_global.js?v=0.4.3" id="motion.global"></script>



  <script type="text/javascript" src="/js/search-toggle.js"></script>

  

  <script type="text/javascript">
    $(document).ready(function () {
      if (CONFIG.sidebar === 'always') {
        displaySidebar();
      }
    });
  </script>

  

  
  
  

  

    <script type="text/javascript">
      var disqus_shortname = 'smartv';
      var disqus_identifier = 'index.html';
      var disqus_title = '';
      var disqus_url = '';

      function run_disqus_script(disqus_script){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      run_disqus_script('count.js');
      
    </script>
  




  
  

  
  <!-- lazyload -->
  <script type="text/javascript" src="/js/lazyload.js"></script>
      <script type="text/javascript">
        jQuery(function() {          
            jQuery("#posts img").lazyload({
              placeholder:"http://www.arao.me/loading.gif",  
                effect:"fadeIn"
              });
            });
    </script>   
</body>
</html>
